<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="30">
    <title>Monitoring Sensor Kandang Ayam</title>
    <link rel="icon" type="image/png" href="chicken.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #c33;
            display: none; /* Disembunyikan secara default */
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #ddd;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }

        .tab:hover {
            background-color: #f8f9fa;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .sensor-value {
            font-size: 2.8em;
            font-weight: bold;
            margin: 15px 0;
            color: #2c3e50;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            display: inline-block;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .status-normal { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-danger { background-color: #e74c3c; }
        .status-info { background-color: #3498db; }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }
        
        .data-selector-wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .data-selector-wrapper label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .data-selector-wrapper select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        .download-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .status-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { border-bottom: 1px solid #ddd; border-right: none; }
            .tab.active { border-right: none; border-bottom-color: #3498db; }
            .header h1 { font-size: 2em; }
            .sensor-value { font-size: 2.2em; }
            th, td { padding: 10px 8px; font-size: 0.9em; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üêî Monitoring Sensor Kandang Ayam</h1>
            <p id="header-info">Memuat data terbaru...</p>
        </div>

        <div id="error-container" class="error-message"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
            <button class="tab" onclick="showTab('charts', event)">üìà Grafik</button>
            <button class="tab" onclick="showTab('table', event)">üìã Data Tabel</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div id="dashboard-content">
                <div class="loading">Memuat dashboard dari Supabase...</div>
            </div>
        </div>

        <div id="charts" class="tab-content">
             <div id="charts-selector-container"></div>
            <div id="charts-content">
                <div class="loading">Memuat grafik dari Supabase...</div>
            </div>
        </div>

        <div id="table" class="tab-content">
            <div id="table-selector-container"></div>
            <div id="table-content">
                <div class="loading">Memuat tabel dari Supabase...</div>
            </div>
        </div>

        <div class="refresh-info">
            üîÑ Halaman ini akan refresh otomatis setiap 30 detik untuk mendapatkan data terbaru.
        </div>
    </div>

    <script>
        // ========== Konfigurasi Supabase ==========
        const SUPABASE_URL = "https://upjzvpdeegonoducgogf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwanp2cGRlZWdvbm9kdWNnb2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyNzY4NjksImV4cCI6MjA2Mjg1Mjg2OX0.phMGvBFH2B7NWAiCfE1eTkbpoIty1Cp9GT0-89LRCkE";
        const TABLE_NAME = "tabelayam2";

        // ========== State & Konfigurasi Global ==========
        let currentLimit = 10; // Nilai default
        let tempHumidityChartInstance = null;
        let ammoniaChartInstance = null;
        let allDataCache = []; // Cache untuk data CSV

        // ========== Fungsi Helper ==========
        function getTemperatureStatus(temp) {
            if (temp < 25) return "Lampu Menyala";
            if (temp > 28) return "Kipas Menyala";
            return "Suhu Normal";
        }

        function getAirQualityStatus(ppm) {
            if (ppm >= 25) return "Sangat Buruk";
            if (ppm >= 20) return "Buruk";
            if (ppm >= 11) return "Normal";
            return "Baik";
        }
        
        function getTempStatusClass(status) {
            if (status === 'Lampu Menyala') return 'status-info';
            if (status === 'Kipas Menyala') return 'status-danger';
            return 'status-normal';
        }

        function getAirQualityStatusClass(status) {
            if (status === 'Sangat Buruk') return 'status-danger';
            if (status === 'Buruk' || status === 'Normal') return 'status-warning';
            return 'status-normal';
        }

        // ========== Fungsi Pengambilan Data ==========
        async function getSupabaseData(limit) {
            const endpoint = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?order=id.desc&limit=${limit}`;
            const headers = {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`,
                "Content-Type": "application/json"
            };

            const response = await fetch(endpoint, { headers });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
            }
            return await response.json();
        }

        // ========== Fungsi untuk Render Konten ==========
        function updateDashboard(latestData) {
            const tempStatus = getTemperatureStatus(latestData.suhu);
            const airQuality = getAirQualityStatus(latestData.amonia);
            
            const content = `
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üå°Ô∏è Suhu</h3>
                        <div class="sensor-value">${latestData.suhu}¬∞C</div>
                        <span class="status-badge ${getTempStatusClass(tempStatus)}">${tempStatus}</span>
                    </div>
                    <div class="card">
                        <h3>üíß Kelembaban</h3>
                        <div class="sensor-value">${latestData.kelembaban}%</div>
                        <span class="status-badge status-info">Kelembaban Udara</span>
                    </div>
                    <div class="card">
                        <h3>üí® Gas Amonia</h3>
                        <div class="sensor-value">${parseFloat(latestData.amonia).toFixed(2)} ppm</div>
                        <span class="status-badge ${getAirQualityStatusClass(airQuality)}">Kualitas Udara: ${airQuality}</span>
                    </div>
                </div>
                <div class="status-legend">
                    <div class="card">
                        <h3>üéõÔ∏è Status Kontrol Suhu</h3>
                        <div class="legend-item"><div class="legend-color" style="background-color: #3498db;"></div><span>Suhu < 25¬∞C: Lampu Menyala</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #27ae60;"></div><span>Suhu 25-28¬∞C: Suhu Normal</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>Suhu > 28¬∞C: Kipas Menyala</span></div>
                    </div>
                    <div class="card">
                        <h3>üå¨Ô∏è Status Kualitas Udara (PPM)</h3>
                        <div class="legend-item"><div class="legend-color" style="background-color: #27ae60;"></div><span>0-10 ppm: Baik</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #f39c12;"></div><span>11-24 ppm: Normal/Buruk</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>‚â•25 ppm: Sangat Buruk</span></div>
                    </div>
                </div>`;
            document.getElementById('dashboard-content').innerHTML = content;
        }
        
        function renderCharts(chartData) {
            if (tempHumidityChartInstance) tempHumidityChartInstance.destroy();
            if (ammoniaChartInstance) ammoniaChartInstance.destroy();

            const reversedData = [...chartData].reverse();
            const content = `
                <div class="card">
                    <h3>üìä Grafik Suhu dan Kelembaban (${chartData.length} Data Terakhir)</h3>
                    <div class="chart-container"><canvas id="tempHumidityChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>üìà Grafik Gas Amonia PPM (${chartData.length} Data Terakhir)</h3>
                    <div class="chart-container"><canvas id="ammoniaChart"></canvas></div>
                </div>`;
            document.getElementById('charts-content').innerHTML = content;

            const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } } }, scales: { y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.1)' } }, x: { grid: { color: 'rgba(0,0,0,0.1)' } } } };

            // Grafik Suhu dan Kelembaban
            const tempHumidityCtx = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChartInstance = new Chart(tempHumidityCtx, {
                type: 'line',
                data: {
                    labels: reversedData.map(item => `ID: ${item.id}`),
                    datasets: [{
                        label: 'Suhu (¬∞C)',
                        data: reversedData.map(item => parseFloat(item.suhu)),
                        borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.4, borderWidth: 3, pointRadius: 5
                    }, {
                        label: 'Kelembaban (%)',
                        data: reversedData.map(item => parseFloat(item.kelembaban)),
                        borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.4, borderWidth: 3, pointRadius: 5
                    }]
                },
                options: chartOptions
            });

            // Grafik Gas Amonia (PPM)
            const ammoniaCtx = document.getElementById('ammoniaChart').getContext('2d');
            ammoniaChartInstance = new Chart(ammoniaCtx, {
                type: 'line',
                data: {
                    labels: reversedData.map(item => `ID: ${item.id}`),
                    datasets: [{
                        label: 'Gas Amonia (ppm)',
                        data: reversedData.map(item => parseFloat(item.amonia)),
                        borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', tension: 0.4, borderWidth: 3, pointRadius: 5
                    }]
                },
                options: chartOptions
            });
        }

        function populateTable(tableData) {
            allDataCache = tableData; // Simpan data untuk diunduh
            let tableRows = '';
            tableData.forEach((row, index) => {
                const tempStatus = getTemperatureStatus(row.suhu);
                const airQuality = getAirQualityStatus(row.amonia);
                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${row.id}</td>
                        <td>${row.suhu}</td>
                        <td><span class="status-badge ${getTempStatusClass(tempStatus)}">${tempStatus}</span></td>
                        <td>${row.kelembaban}</td>
                        <td>${parseFloat(row.amonia).toFixed(2)}</td>
                        <td><span class="status-badge ${getAirQualityStatusClass(airQuality)}">${airQuality}</span></td>
                    </tr>`;
            });

            const content = `
                <div class="card">
                    <h3>üìã Tabel Data Sensor (${tableData.length} Data Terakhir)</h3>
                    <button class="download-btn" onclick="downloadCSV()">üì• Unduh CSV</button>
                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>No</th><th>ID Data</th><th>Suhu (¬∞C)</th><th>Status Suhu</th><th>Kelembaban (%)</th><th>Gas Amonia (ppm)</th><th>Kualitas Udara</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('table-content').innerHTML = content;
        }

        // ========== Fungsi Kontrol UI ==========
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function createDataSelectors() {
            const selectorHTML = `
                <div class="data-selector-wrapper">
                  <label for="limit-selector">Tampilkan Data Terakhir:</label>
                  <select id="limit-selector-charts" onchange="handleLimitChange(event)">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </div>`;

            document.getElementById('charts-selector-container').innerHTML = selectorHTML;
            
            const selectorHTMLTable = `
                <div class="data-selector-wrapper">
                  <label for="limit-selector">Tampilkan Data Terakhir:</label>
                  <select id="limit-selector-table" onchange="handleLimitChange(event)">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </div>`;
            document.getElementById('table-selector-container').innerHTML = selectorHTMLTable;
        }
        
        async function handleLimitChange(event) {
            const newLimit = parseInt(event.target.value, 10);
            currentLimit = newLimit;

            // Update both selectors to be in sync
            document.getElementById('limit-selector-charts').value = newLimit;
            document.getElementById('limit-selector-table').value = newLimit;

            await refreshAllData(currentLimit);
        }

        function downloadCSV() {
            if (!allDataCache || allDataCache.length === 0) {
                alert('Tidak ada data untuk diunduh');
                return;
            }
            let csv = [];
            const headers = ["No", "ID Data", "Suhu (C)", "Status Suhu", "Kelembaban (%)", "Gas Amonia (ppm)", "Kualitas Udara"];
            csv.push(headers.join(','));

            allDataCache.forEach((row, index) => {
                const tempStatus = getTemperatureStatus(row.suhu);
                const airQuality = getAirQualityStatus(row.amonia);
                const csvRow = [
                    index + 1,
                    row.id,
                    row.suhu,
                    `"${tempStatus}"`,
                    row.kelembaban,
                    parseFloat(row.amonia).toFixed(2),
                    `"${airQuality}"`
                ];
                csv.push(csvRow.join(','));
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_sensor_kandang_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ========== Fungsi Utama yang Dijalankan Saat Halaman Dimuat ==========
        async function refreshAllData(limit) {
            // Show loading indicators
            document.getElementById('charts-content').innerHTML = '<div class="loading">Memuat data...</div>';
            document.getElementById('table-content').innerHTML = '<div class="loading">Memuat data...</div>';
            
            try {
                const data = await getSupabaseData(limit);
                if (data && data.length > 0) {
                    const latestData = data[0];
                    
                    document.getElementById('header-info').innerText = 
                        `Data ID terakhir: ${latestData.id} | Suhu: ${latestData.suhu}¬∞C | Kelembaban: ${latestData.kelembaban}% | Gas Amonia: ${parseFloat(latestData.amonia).toFixed(2)} ppm`;

                    // Render all components
                    updateDashboard(latestData); // Dashboard only needs the latest data
                    renderCharts(data);
                    populateTable(data);
                } else {
                    throw new Error("Tidak ada data yang diterima dari Supabase.");
                }
            } catch (error) {
                console.error("Gagal memuat data:", error);
                const errorContainer = document.getElementById('error-container');
                errorContainer.style.display = 'block';
                errorContainer.innerHTML = `<strong>Error:</strong> ${error.message}<br><small>Pastikan koneksi internet stabil dan konfigurasi Supabase benar.</small>`;
                
                // Clear content on error
                document.getElementById('dashboard-content').innerHTML = '';
                document.getElementById('charts-content').innerHTML = '';
                document.getElementById('table-content').innerHTML = '';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            createDataSelectors();
            await refreshAllData(currentLimit); // Initial load with default limit
        });
    </script>
</body>

</html>
